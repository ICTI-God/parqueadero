<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Parqueadero</title>

    <!-- === MEJORAS PARA LA EXPERIENCIA DE APP MÓVIL (CON TU LOGO) === -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#c00000">
    <!-- Icono para iOS -->
    <link rel="apple-touch-icon" href="logo.png">
    <!-- Icono para la pestaña del navegador (Favicon) -->
    <link rel="icon" href="logo.png">
    <!-- Manifiesto para Android y Web App -->
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;Control Parqueadero ICTI&quot;,
        &quot;short_name&quot;: &quot;Parqueadero&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#f0f2f5&quot;,
        &quot;theme_color&quot;: &quot;#c00000&quot;,
        &quot;description&quot;: &quot;App para controlar la entrada y salida de vehículos.&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;logo.png&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/png&quot; },
            { &quot;src&quot;: &quot;logo.png&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot; }
        ]
    }">
    <!-- === FIN DE LAS MEJORAS === -->

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Estilos para el scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Animación de entrada para las tarjetas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .vehicle-card { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal -->
    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8">

        <!-- Cabecera -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Control de Parqueadero</h1>
            <p class="text-gray-500 mt-2">Gestiona la entrada y salida de vehículos de forma sencilla.</p>
            <div id="loading" class="mt-4 text-blue-600">Conectando a tu base de datos...</div>
            <div id="userInfo" class="hidden mt-2 text-xs text-gray-400 bg-gray-200 rounded-full px-3 py-1 inline-block">
                ID de Sesión: <span id="userId" class="font-mono"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Registro y Tarifas -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Formulario de Registro de Entrada -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 flex items-center">
                        <span class="lucide-icon" data-lucide="log-in" class="mr-2"></span> Registrar Entrada
                    </h2>
                    <form id="entryForm" class="space-y-4">
                        <div>
                            <label for="plate" class="block text-sm font-medium text-gray-700">Placa del Vehículo</label>
                            <input type="text" id="plate" name="plate" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="AAA-123">
                        </div>
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700">Tipo de Vehículo</label>
                            <select id="type" name="type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="car">Carro</option>
                                <option value="motorcycle">Moto</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 flex items-center justify-center">
                             <span class="lucide-icon" data-lucide="plus-circle" class="mr-2"></span>
                            Añadir Vehículo
                        </button>
                    </form>
                </div>
                 <!-- Panel de Tarifas -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <span class="lucide-icon" data-lucide="dollar-sign" class="mr-2"></span> Tarifas por Minuto
                    </h3>
                    <div class="space-y-2 text-gray-600">
                        <p class="flex justify-between"><span>Carro:</span> <span class="font-semibold" id="carRateText">$100</span></p>
                        <p class="flex justify-between"><span>Moto:</span> <span class="font-semibold" id="motorcycleRateText">$50</span></p>
                    </div>
                </div>
            </div>

            <!-- Columna de Vehículos Estacionados -->
            <div class="lg:col-span-2">
                 <div class="bg-white p-6 rounded-2xl shadow-lg min-h-[400px]">
                    <h2 class="text-2xl font-semibold mb-4 flex items-center">
                         <span class="lucide-icon" data-lucide="car" class="mr-2"></span> Vehículos Estacionados (<span id="vehicleCount">0</span>)
                    </h2>
                    <div id="vehiclesList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <!-- Las tarjetas de vehículos se insertarán aquí -->
                    </div>
                     <div id="emptyState" class="hidden text-center py-16">
                        <span class="lucide-icon" data-lucide="parking-circle-off" class="mx-auto h-16 w-16 text-gray-300"></span>
                        <h3 class="mt-4 text-lg font-medium text-gray-800">Parqueadero Vacío</h3>
                        <p class="mt-1 text-sm text-gray-500">No hay vehículos estacionados en este momento.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal para Confirmación y Factura -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                     <span class="lucide-icon" data-lucide="check" class="h-6 w-6 text-green-600"></span>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title">¡Salida Registrada!</h3>
                <div class="mt-2 px-7 py-3">
                    <div id="modal-content" class="text-sm text-gray-500 space-y-3">
                        <!-- El contenido de la factura se insertará aquí -->
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
     <!-- Modal para Errores -->
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <span class="lucide-icon" data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></span>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Error</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="error-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-error-modal" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, query, where, getDocs, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        // Tus credenciales de Firebase. ¡Ya eres dueño de la app!
        const firebaseConfig = {
          apiKey: "AIzaSyDtdGTae_t4vOGGmYDK5AaKRZA5hHNo3Ng",
          authDomain: "transformation-parking.firebaseapp.com",
          projectId: "transformation-parking",
          storageBucket: "transformation-parking.firebasestorage.app",
          messagingSenderId: "911384997480",
          appId: "1:911384997480:web:24ca03e41b5b9bca91d5dd",
          measurementId: "G-GXF3QM2MBZ"
        };

        // Tarifas del parqueadero (por minuto)
        const RATES = {
            car: 100,
            motorcycle: 50
        };

        // --- INICIALIZACIÓN DE FIREBASE ---
        let app, auth, db, userId;
        let vehiclesCollectionRef; // Referencia a la colección de vehículos del usuario

        // Elementos del DOM
        const loadingDiv = document.getElementById('loading');
        const userInfoDiv = document.getElementById('userInfo');
        const userIdSpan = document.getElementById('userId');
        const entryForm = document.getElementById('entryForm');
        const plateInput = document.getElementById('plate');
        const vehiclesListDiv = document.getElementById('vehiclesList');
        const vehicleCountSpan = document.getElementById('vehicleCount');
        const emptyStateDiv = document.getElementById('emptyState');
        const modal = document.getElementById('modal');
        const closeModalButton = document.getElementById('close-modal');
        const errorModal = document.getElementById('error-modal');
        const closeErrorModalButton = document.getElementById('close-error-modal');
        const errorMessageP = document.getElementById('error-message');


        // --- FUNCIONES DE LA APLICACIÓN ---

        // Función para mostrar errores en un modal
        function showError(message) {
            errorMessageP.textContent = message;
            errorModal.classList.remove('hidden');
        }

        // Función para renderizar los iconos de Lucide
        function renderIcons() {
            document.querySelectorAll('.lucide-icon').forEach(elem => {
                const iconName = elem.getAttribute('data-lucide');
                if (window.LucideReact && window.React && window.ReactDOM && iconName) {
                    const iconElement = window.React.createElement(window.LucideReact[iconName]);
                    window.ReactDOM.render(iconElement, elem);
                }
            });
        }
        
        // Formateador de moneda
        const currencyFormatter = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
        });

        // Función principal que se ejecuta al cargar la página
        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Persistencia de la sesión
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // La ruta de la base de datos ahora es más simple
                        vehiclesCollectionRef = collection(db, `users/${userId}/vehicles`);
                        
                        loadingDiv.classList.add('hidden');
                        userIdSpan.textContent = userId;
                        userInfoDiv.classList.remove('hidden');
                        
                        // Empezar a escuchar los cambios en la base de datos
                        listenForVehicles();
                        
                    } else {
                        // Iniciar sesión de forma anónima
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error en el inicio de sesión anónimo: ", error);
                            showError("No se pudo iniciar sesión. La aplicación no funcionará correctamente.");
                            loadingDiv.textContent = "Error de autenticación.";
                        }
                    }
                });

            } catch (error) {
                console.error("Error inicializando Firebase: ", error);
                showError("Error crítico al conectar con la base de datos.");
                loadingDiv.textContent = "Error de conexión.";
            }
            
            setupEventListeners();
            renderIcons();
            document.getElementById('carRateText').textContent = currencyFormatter.format(RATES.car);
            document.getElementById('motorcycleRateText').textContent = currencyFormatter.format(RATES.motorcycle);
        }

        // Configurar todos los event listeners
        function setupEventListeners() {
            entryForm.addEventListener('submit', handleAddVehicle);
            closeModalButton.addEventListener('click', () => modal.classList.add('hidden'));
            closeErrorModalButton.addEventListener('click', () => errorModal.classList.add('hidden'));
        }

        // Escuchar cambios en la colección de vehículos en tiempo real
        function listenForVehicles() {
            if (!vehiclesCollectionRef) return;
            
            onSnapshot(query(vehiclesCollectionRef), (snapshot) => {
                const vehicles = [];
                snapshot.forEach(doc => {
                    vehicles.push({ id: doc.id, ...doc.data() });
                });
                renderVehicles(vehicles);
            }, (error) => {
                console.error("Error al obtener vehículos: ", error);
                showError("No se pudo obtener la lista de vehículos.");
            });
        }
        
        // Manejar el envío del formulario para añadir un vehículo
        async function handleAddVehicle(e) {
            e.preventDefault();
            const plate = plateInput.value.toUpperCase().trim();
            const type = document.getElementById('type').value;

            if (!plate) {
                showError("La placa no puede estar vacía.");
                return;
            }
            
            if (!vehiclesCollectionRef) {
                showError("La base de datos no está lista. Inténtalo de nuevo en un momento.");
                return;
            }

            // Verificar si la placa ya existe
            const q = query(vehiclesCollectionRef, where("plate", "==", plate));
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showError(`El vehículo con placa ${plate} ya se encuentra en el parqueadero.`);
                    return;
                }
    
                // Si no existe, añadir el nuevo vehículo
                await addDoc(vehiclesCollectionRef, {
                    plate,
                    type,
                    entryTime: serverTimestamp() // Usar el timestamp del servidor para mayor precisión
                });
                entryForm.reset();

            } catch (error) {
                console.error("Error al añadir vehículo: ", error);
                showError("Ocurrió un error al registrar el vehículo.");
            }
        }

        // Renderizar la lista de vehículos en el DOM
        function renderVehicles(vehicles) {
            vehiclesListDiv.innerHTML = '';
            vehicleCountSpan.textContent = vehicles.length;

            if (vehicles.length === 0) {
                emptyStateDiv.classList.remove('hidden');
            } else {
                emptyStateDiv.classList.add('hidden');
                vehicles.sort((a, b) => a.entryTime?.seconds - b.entryTime?.seconds); // Ordenar por tiempo de entrada
                vehicles.forEach(vehicle => {
                    const vehicleCard = createVehicleCard(vehicle);
                    vehiclesListDiv.appendChild(vehicleCard);
                });
                 renderIcons();
            }
        }

        // Crear una tarjeta HTML para un vehículo
        function createVehicleCard(vehicle) {
            const card = document.createElement('div');
            card.className = `vehicle-card p-4 rounded-xl shadow-md flex flex-col justify-between transition-all duration-300 ${vehicle.type === 'car' ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200'} border`;
            
            const entryTime = vehicle.entryTime ? new Date(vehicle.entryTime.seconds * 1000).toLocaleString('es-CO') : 'Registrando...';

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg ${vehicle.type === 'car' ? 'text-blue-800' : 'text-orange-800'}">${vehicle.plate}</span>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${vehicle.type === 'car' ? 'bg-blue-200 text-blue-800' : 'bg-orange-200 text-orange-800'}">${vehicle.type === 'car' ? 'Carro' : 'Moto'}</span>
                    </div>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">Entrada:</span> ${entryTime}
                    </p>
                </div>
                <button data-id="${vehicle.id}" class="register-exit-btn mt-4 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105 flex items-center justify-center">
                    <span class="lucide-icon" data-lucide="log-out" class="mr-2"></span>
                    Registrar Salida
                </button>
            `;
            
            card.querySelector('.register-exit-btn').addEventListener('click', () => handleRegisterExit(vehicle));
            
            return card;
        }

        // Manejar el registro de salida de un vehículo
        async function handleRegisterExit(vehicle) {
            const exitTime = new Date();
            const entryTime = new Date(vehicle.entryTime.seconds * 1000);

            const durationMs = exitTime - entryTime;
            const durationMinutes = Math.ceil(durationMs / (1000 * 60)); // Redondear al siguiente minuto

            const rate = RATES[vehicle.type];
            const cost = durationMinutes * rate;
            
            // Mostrar la factura en el modal
            showBill(vehicle, entryTime, exitTime, durationMinutes, cost);

            // Eliminar el documento de la base de datos
            try {
                const vehicleDocRef = doc(db, `users/${userId}/vehicles`, vehicle.id);
                await deleteDoc(vehicleDocRef);
            } catch (error) {
                console.error("Error al registrar salida: ", error);
                showError("No se pudo eliminar el vehículo de la base de datos.");
            }
        }
        
        // Mostrar la factura en el modal
        function showBill(vehicle, entry, exit, duration, cost) {
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            modalTitle.textContent = `Salida de ${vehicle.plate}`;
            modalContent.innerHTML = `
                <p class="text-lg font-bold text-green-600">Total a Pagar: ${currencyFormatter.format(cost)}</p>
                <div class="text-left space-y-2 border-t pt-3 mt-3">
                    <p><strong>Placa:</strong> ${vehicle.plate}</p>
                    <p><strong>Tipo:</strong> ${vehicle.type === 'car' ? 'Carro' : 'Moto'}</p>
                    <p><strong>Entrada:</strong> ${entry.toLocaleString('es-CO')}</p>
                    <p><strong>Salida:</strong> ${exit.toLocaleString('es-CO')}</p>
                    <p><strong>Tiempo:</strong> ${duration} minutos</p>
                    <p><strong>Tarifa:</strong> ${currencyFormatter.format(RATES[vehicle.type])} / minuto</p>
                </div>
            `;
            modal.classList.remove('hidden');
        }


        // Iniciar la aplicación
        main();

    </script>

</body>
</html>
```